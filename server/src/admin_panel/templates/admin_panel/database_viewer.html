<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>AXPHONE - Database Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
        }

        .tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 5px;
            margin-bottom: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .tab {
            flex: 1;
            padding: 12px 20px;
            text-align: center;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .tab.active {
            background: #667eea;
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .tab:hover:not(.active) {
            background: rgba(102, 126, 234, 0.1);
        }

        .content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 0.9em;
            color: #666;
            font-weight: 500;
        }

        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9em;
        }

        .btn {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.2s ease;
        }

        .btn:hover {
            background: #5a6fd8;
        }

        .btn-secondary {
            background: #95a5a6;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 500;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
        }

        .pagination button:hover:not(:disabled) {
            background: #f0f0f0;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination .current {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .search-form {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            flex: 1;
        }

        .conversation-viewer {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }

        .message-bubble {
            background: white;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .message-meta {
            font-size: 0.8em;
            color: #666;
            margin-bottom: 5px;
        }

        .hash-display {
            font-family: 'Courier New', monospace;
            background: #f8f9fa;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            word-break: break-all;
        }

        .bulk-actions {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
            align-items: center;
            gap: 15px;
            border: 2px solid #667eea;
        }

        .bulk-actions.show {
            display: flex;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .checkbox-column {
            width: 40px;
            text-align: center;
        }

        .user-checkbox {
            cursor: pointer;
            transform: scale(1.2);
        }

        .select-all-checkbox {
            cursor: pointer;
            transform: scale(1.3);
        }

        .selected-count {
            font-weight: bold;
            color: #667eea;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .filters {
                flex-direction: column;
            }
            
            .bulk-actions {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            
            table {
                font-size: 0.9em;
            }
            
            th, td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    {% csrf_token %}
    <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1>üîê AXPHONE Database Viewer</h1>
                    <p>Visualizzazione dei metadati del database (contenuti cifrati non visibili)</p>
                </div>
                <div>
                    <span style="margin-right: 15px; color: #666;">Benvenuto, {{ user.username }}</span>
                    <a href="{% url 'admin_panel:admin_logout' %}" class="btn btn-secondary">Logout</a>
                </div>
            </div>
        </div>

        <div class="stats-grid" id="statsGrid">
            <!-- Le statistiche verranno caricate via JavaScript -->
        </div>

        <div class="tabs">
            <div class="tab active" data-tab="users">üë• Utenti</div>
            <div class="tab" data-tab="groups">üë• Gruppi</div>
            <div class="tab" data-tab="messages">üí¨ Messaggi</div>
            <div class="tab" data-tab="sessions">üîó Sessioni</div>
            <div class="tab" data-tab="conversations">üó®Ô∏è Conversazioni</div>
        </div>

        <div class="content">
            <!-- Tab Utenti -->
            <div class="tab-content active" id="users">
                <h3>Utenti Registrati</h3>
                
                <!-- Azioni bulk -->
                <div class="bulk-actions" id="bulkActions">
                    <span class="selected-count" id="selectedCount">0 utenti selezionati</span>
                    <button class="btn btn-danger" onclick="deleteSelectedUsers()">
                        üóëÔ∏è Elimina Utenti Selezionati
                    </button>
                    <button class="btn btn-secondary" onclick="clearSelection()">
                        ‚úñÔ∏è Annulla Selezione
                    </button>
                </div>
                
                <div id="usersTable">
                    <div class="loading">
                        <div class="spinner"></div>
                        Caricamento utenti...
                    </div>
                </div>
            </div>

            <!-- Tab Gruppi -->
            <div class="tab-content" id="groups">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>Gestione Gruppi Utenti</h3>
                    <button class="btn" onclick="showCreateGroupModal()">
                        ‚ûï Crea Nuovo Gruppo
                    </button>
                </div>
                
                <div id="groupsTable">
                    <div class="loading">
                        <div class="spinner"></div>
                        Caricamento gruppi...
                    </div>
                </div>
                
                <!-- Modal per creazione/modifica gruppo -->
                <div id="groupModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 500px;">
                        <h4 id="groupModalTitle">Crea Nuovo Gruppo</h4>
                        <form id="groupForm" style="margin-top: 20px;">
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Nome Gruppo:</label>
                                <input type="text" id="groupName" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Descrizione:</label>
                                <textarea id="groupDescription" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; height: 80px;"></textarea>
                            </div>
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Colore:</label>
                                <input type="color" id="groupColor" value="#667eea" style="width: 100%; height: 40px; border: 1px solid #ddd; border-radius: 6px;">
                            </div>
                            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                                <button type="button" class="btn btn-secondary" onclick="closeGroupModal()">Annulla</button>
                                <button type="submit" class="btn">Salva Gruppo</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Tab Messaggi -->
            <div class="tab-content" id="messages">
                <h3>Messaggi (Solo Metadati)</h3>
                <div class="filters">
                    <div class="filter-group">
                        <label>Utente:</label>
                        <select id="userFilter">
                            <option value="">Tutti gli utenti</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Tipo Messaggio:</label>
                        <select id="typeFilter">
                            <option value="">Tutti i tipi</option>
                            <option value="text">Testo</option>
                            <option value="image">Immagine</option>
                            <option value="video">Video</option>
                            <option value="audio">Audio</option>
                            <option value="file">File</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Da Data:</label>
                        <input type="date" id="dateFromFilter">
                    </div>
                    <div class="filter-group">
                        <label>A Data:</label>
                        <input type="date" id="dateToFilter">
                    </div>
                    <div class="filter-group">
                        <label>&nbsp;</label>
                        <button class="btn" onclick="loadMessages()">Filtra</button>
                        <button class="btn btn-secondary" onclick="clearMessageFilters()">Reset</button>
                    </div>
                </div>
                <div id="messagesTable">
                    <div class="loading">
                        <div class="spinner"></div>
                        Caricamento messaggi...
                    </div>
                </div>
                <div id="messagesPagination" class="pagination"></div>
            </div>

            <!-- Tab Sessioni -->
            <div class="tab-content" id="sessions">
                <h3>Sessioni Attive</h3>
                <div id="sessionsTable">
                    <div class="loading">
                        <div class="spinner"></div>
                        Caricamento sessioni...
                    </div>
                </div>
            </div>

            <!-- Tab Conversazioni -->
            <div class="tab-content" id="conversations">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>Ricerca Conversazioni</h3>
                    <button class="btn" onclick="refreshCurrentConversation()" id="refreshConversationBtn" style="display: none;">
                        üîÑ Aggiorna Conversazione
                    </button>
                </div>
                <div class="search-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Primo Utente:</label>
                            <select id="user1Select">
                                <option value="">Seleziona utente</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Secondo Utente:</label>
                            <select id="user2Select">
                                <option value="">Seleziona utente</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button class="btn" onclick="searchConversation()">Cerca Conversazione</button>
                        </div>
                    </div>
                </div>
                <div id="conversationResult"></div>
            </div>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let usersData = [];
        let currentConversationUsers = null; // Per tenere traccia della conversazione attuale
        let conversationRefreshInterval = null; // Per l'auto-refresh

        // Gestione tab
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const tabName = this.dataset.tab;
                
                // Ferma l'auto-refresh delle conversazioni quando si cambia tab
                if (tabName !== 'conversations' && conversationRefreshInterval) {
                    clearInterval(conversationRefreshInterval);
                    conversationRefreshInterval = null;
                    document.getElementById('refreshConversationBtn').style.display = 'none';
                }
                
                // Aggiorna tab attivo
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // Aggiorna contenuto attivo
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                document.getElementById(tabName).classList.add('active');
                
                // Carica dati se necessario
                switch(tabName) {
                    case 'users':
                        loadUsers();
                        break;
                    case 'groups':
                        loadGroups();
                        break;
                    case 'messages':
                        loadMessages();
                        break;
                    case 'sessions':
                        loadSessions();
                        break;
                    case 'conversations':
                        loadUsersForConversations();
                        // Riavvia l'auto-refresh se c'√® una conversazione attiva
                        if (currentConversationUsers && !conversationRefreshInterval) {
                            document.getElementById('refreshConversationBtn').style.display = 'block';
                            conversationRefreshInterval = setInterval(refreshCurrentConversation, 5000);
                        }
                        break;
                }
            });
        });

        // Carica statistiche
        async function loadStatistics() {
            try {
                const response = await fetch('/admin/api/statistics/');
                const stats = await response.json();
                
                const statsGrid = document.getElementById('statsGrid');
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number">${stats.users.total}</div>
                        <div class="stat-label">Utenti Totali</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.users.active}</div>
                        <div class="stat-label">Utenti Attivi</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.devices.active}</div>
                        <div class="stat-label">Dispositivi Attivi</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.messages.total}</div>
                        <div class="stat-label">Messaggi Totali</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.messages.last_24h}</div>
                        <div class="stat-label">Messaggi 24h</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.sessions.total}</div>
                        <div class="stat-label">Sessioni Totali</div>
                    </div>
                `;
            } catch (error) {
                console.error('Errore nel caricamento delle statistiche:', error);
            }
        }

        // Carica utenti
        async function loadUsers() {
            try {
                const response = await fetch('/admin/api/users/');
                const data = await response.json();
                usersData = data.users;
                
                const usersTable = document.getElementById('usersTable');
                usersTable.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th class="checkbox-column">
                                    <input type="checkbox" class="select-all-checkbox" onchange="toggleSelectAll(this)">
                                </th>
                                <th>ID</th>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Nome</th>
                                <th>Stato</th>
                                <th>Gruppi</th>
                                <th>Dispositivi</th>
                                <th>Ultimo Login</th>
                                <th>Registrato</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.users.map(user => `
                                <tr>
                                    <td class="checkbox-column">
                                        <input type="checkbox" class="user-checkbox" value="${user.id}" onchange="updateBulkActions()">
                                    </td>
                                    <td>${user.id}</td>
                                    <td><strong>${user.username}</strong></td>
                                    <td>${user.email}</td>
                                    <td>${user.first_name} ${user.last_name}</td>
                                    <td>
                                        <span class="badge ${user.is_active ? 'badge-success' : 'badge-danger'}">
                                            ${user.is_active ? 'Attivo' : 'Inattivo'}
                                        </span>
                                    </td>
                                    <td>
                                        ${user.groups.length > 0 ? 
                                            user.groups.map(group => `
                                                <span class="badge" style="background: ${group.color}20; color: ${group.color}; border: 1px solid ${group.color}40;">
                                                    ${group.name}
                                                </span>
                                            `).join(' ') : 
                                            '<span style="color: #999; font-style: italic;">Nessun gruppo</span>'
                                        }
                                    </td>
                                    <td>
                                        <span class="badge badge-info">${user.devices_count} dispositivi</span>
                                        ${user.devices.map(device => `
                                            <div style="font-size: 0.8em; color: #666;">
                                                ${device.name} (${device.type})
                                            </div>
                                        `).join('')}
                                    </td>
                                    <td>${user.last_login ? new Date(user.last_login).toLocaleString() : 'Mai'}</td>
                                    <td>${new Date(user.date_joined).toLocaleDateString()}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
                // Popola i filtri utente
                populateUserFilters();
            } catch (error) {
                console.error('Errore nel caricamento degli utenti:', error);
                document.getElementById('usersTable').innerHTML = '<p>Errore nel caricamento degli utenti</p>';
            }
        }

        // Popola i filtri utente
        function populateUserFilters() {
            const userFilter = document.getElementById('userFilter');
            const user1Select = document.getElementById('user1Select');
            const user2Select = document.getElementById('user2Select');
            
            const userOptions = usersData.map(user => 
                `<option value="${user.id}">${user.username} (${user.first_name} ${user.last_name})</option>`
            ).join('');
            
            userFilter.innerHTML = '<option value="">Tutti gli utenti</option>' + userOptions;
            user1Select.innerHTML = '<option value="">Seleziona utente</option>' + userOptions;
            user2Select.innerHTML = '<option value="">Seleziona utente</option>' + userOptions;
        }

        // Carica messaggi
        async function loadMessages(page = 1) {
            try {
                const userFilter = document.getElementById('userFilter').value;
                const typeFilter = document.getElementById('typeFilter').value;
                const dateFromFilter = document.getElementById('dateFromFilter').value;
                const dateToFilter = document.getElementById('dateToFilter').value;
                
                const params = new URLSearchParams({
                    page: page,
                    per_page: 50
                });
                
                if (userFilter) params.append('user_id', userFilter);
                if (typeFilter) params.append('message_type', typeFilter);
                if (dateFromFilter) params.append('date_from', dateFromFilter);
                if (dateToFilter) params.append('date_to', dateToFilter);
                
                const response = await fetch(`/admin/api/messages/?${params}`);
                const data = await response.json();
                
                const messagesTable = document.getElementById('messagesTable');
                messagesTable.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Mittente</th>
                                <th>Destinatario</th>
                                <th>Tipo</th>
                                <th>Hash Contenuto</th>
                                <th>Creato</th>
                                <th>Consegnato</th>
                                <th>Letto</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.messages.map(message => `
                                <tr>
                                    <td>${message.id.substr(0, 8)}...</td>
                                    <td>
                                        <strong>${message.sender.username}</strong><br>
                                        <small>${message.sender.device_name}</small>
                                    </td>
                                    <td>
                                        <strong>${message.recipient.username}</strong><br>
                                        <small>${message.recipient.device_name}</small>
                                    </td>
                                    <td>
                                        <span class="badge badge-info">${message.message_type}</span>
                                    </td>
                                    <td>
                                        <div class="hash-display">${message.encrypted_content_hash}</div>
                                    </td>
                                    <td>${new Date(message.created_at).toLocaleString()}</td>
                                    <td>
                                        ${message.delivered_at ? 
                                            `<span class="badge badge-success">‚úì</span> ${new Date(message.delivered_at).toLocaleString()}` : 
                                            '<span class="badge badge-warning">Pendente</span>'
                                        }
                                    </td>
                                    <td>
                                        ${message.read_at ? 
                                            `<span class="badge badge-success">‚úì</span> ${new Date(message.read_at).toLocaleString()}` : 
                                            '<span class="badge badge-warning">Non letto</span>'
                                        }
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
                // Aggiorna paginazione
                updateMessagesPagination(data.pagination);
                
            } catch (error) {
                console.error('Errore nel caricamento dei messaggi:', error);
                document.getElementById('messagesTable').innerHTML = '<p>Errore nel caricamento dei messaggi</p>';
            }
        }

        // Aggiorna paginazione messaggi
        function updateMessagesPagination(pagination) {
            const paginationDiv = document.getElementById('messagesPagination');
            
            let paginationHTML = '';
            
            if (pagination.has_previous) {
                paginationHTML += `<button onclick="loadMessages(${pagination.current_page - 1})">‚Äπ Precedente</button>`;
            }
            
            paginationHTML += `<button class="current">${pagination.current_page} di ${pagination.total_pages}</button>`;
            
            if (pagination.has_next) {
                paginationHTML += `<button onclick="loadMessages(${pagination.current_page + 1})">Successivo ‚Ä∫</button>`;
            }
            
            paginationHTML += `<span style="margin-left: 20px;">Totale: ${pagination.total_count} messaggi</span>`;
            
            paginationDiv.innerHTML = paginationHTML;
        }

        // Pulisci filtri messaggi
        function clearMessageFilters() {
            document.getElementById('userFilter').value = '';
            document.getElementById('typeFilter').value = '';
            document.getElementById('dateFromFilter').value = '';
            document.getElementById('dateToFilter').value = '';
            loadMessages();
        }

        // Carica sessioni
        async function loadSessions() {
            try {
                const response = await fetch('/admin/api/sessions/');
                const data = await response.json();
                
                const sessionsTable = document.getElementById('sessionsTable');
                sessionsTable.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>Utente A</th>
                                <th>Utente B</th>
                                <th>Messaggi</th>
                                <th>Creata</th>
                                <th>Ultimo Messaggio</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.sessions.map(session => `
                                <tr>
                                    <td>
                                        <strong>${session.device_a.user}</strong><br>
                                        <small>${session.device_a.device_name}</small>
                                    </td>
                                    <td>
                                        <strong>${session.device_b.user}</strong><br>
                                        <small>${session.device_b.device_name}</small>
                                    </td>
                                    <td>
                                        <span class="badge badge-info">${session.message_count} messaggi</span>
                                    </td>
                                    <td>${new Date(session.created_at).toLocaleString()}</td>
                                    <td>
                                        ${session.last_message_at ? 
                                            new Date(session.last_message_at).toLocaleString() : 
                                            'Nessun messaggio'
                                        }
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Errore nel caricamento delle sessioni:', error);
                document.getElementById('sessionsTable').innerHTML = '<p>Errore nel caricamento delle sessioni</p>';
            }
        }

        // Carica utenti per conversazioni
        function loadUsersForConversations() {
            if (usersData.length === 0) {
                loadUsers().then(() => populateUserFilters());
            }
        }

        // Cerca conversazione
        async function searchConversation() {
            const user1Id = document.getElementById('user1Select').value;
            const user2Id = document.getElementById('user2Select').value;
            
            if (!user1Id || !user2Id) {
                alert('Seleziona entrambi gli utenti');
                return;
            }
            
            if (user1Id === user2Id) {
                alert('Seleziona due utenti diversi');
                return;
            }
            
            // Salva gli utenti della conversazione corrente
            currentConversationUsers = { user1Id, user2Id };
            
            // Mostra il pulsante di refresh
            document.getElementById('refreshConversationBtn').style.display = 'block';
            
            // Avvia l'auto-refresh ogni 5 secondi
            if (conversationRefreshInterval) {
                clearInterval(conversationRefreshInterval);
            }
            conversationRefreshInterval = setInterval(refreshCurrentConversation, 5000);
            
            await loadConversation(user1Id, user2Id);
        }
        
        // Refresh della conversazione corrente
        async function refreshCurrentConversation() {
            if (!currentConversationUsers) return;
            
            const btn = document.getElementById('refreshConversationBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'üîÑ Aggiornando...';
            btn.disabled = true;
            
            await loadConversation(currentConversationUsers.user1Id, currentConversationUsers.user2Id);
            
            btn.innerHTML = originalText;
            btn.disabled = false;
            
            // Mostra un feedback visivo
            btn.innerHTML = '‚úÖ Aggiornato!';
            setTimeout(() => {
                btn.innerHTML = originalText;
            }, 1000);
        }
        
        // Carica la conversazione (funzione separata per riuso)
        async function loadConversation(user1Id, user2Id) {
            try {
                const response = await fetch(`/admin/api/conversations/?user1_id=${user1Id}&user2_id=${user2Id}`);
                const data = await response.json();
                
                const resultDiv = document.getElementById('conversationResult');
                
                if (data.messages.length === 0) {
                    resultDiv.innerHTML = `
                        <div class="conversation-viewer">
                            <h4>Nessuna conversazione trovata</h4>
                            <p>Non ci sono messaggi tra ${data.user1.username} e ${data.user2.username}</p>
                        </div>
                    `;
                    return;
                }
                
                // Ordina i messaggi per timestamp (dal pi√π recente al pi√π vecchio per mostrare gli ultimi in alto)
                data.messages.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                
                resultDiv.innerHTML = `
                    <div class="conversation-viewer">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4>Conversazione tra ${data.user1.username} e ${data.user2.username}</h4>
                            <span class="badge badge-info">${data.messages.length} messaggi</span>
                        </div>
                        <div style="max-height: 500px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px;">
                            ${data.messages.map(message => {
                                const isRecent = new Date() - new Date(message.created_at) < 60000; // Ultimi 60 secondi
                                return `
                                    <div class="message-bubble" style="${isRecent ? 'border-left-color: #28a745; background: #f8fff9;' : ''}">
                                        <div class="message-meta">
                                            <strong style="${message.sender_username === data.user1.username ? 'color: #667eea;' : 'color: #764ba2;'}">${message.sender_username}</strong> 
                                            ‚Üí <strong style="${message.recipient_username === data.user1.username ? 'color: #667eea;' : 'color: #764ba2;'}">${message.recipient_username}</strong>
                                            | <span style="font-weight: bold;">${new Date(message.created_at).toLocaleString()}</span>
                                            | <span class="badge badge-info">${message.message_type}</span>
                                            ${isRecent ? '<span class="badge badge-success" style="margin-left: 5px;">NUOVO</span>' : ''}
                                        </div>
                                        <div class="hash-display" style="margin: 8px 0;">Hash: ${message.encrypted_content_hash}</div>
                                        <div style="font-size: 0.8em; color: #666;">
                                            ${message.delivered_at ? `‚úÖ Consegnato: ${new Date(message.delivered_at).toLocaleString()}` : '‚è≥ Non consegnato'} |
                                            ${message.read_at ? `üëÅÔ∏è Letto: ${new Date(message.read_at).toLocaleString()}` : 'üì¨ Non letto'}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <div style="margin-top: 10px; font-size: 0.9em; color: #666; text-align: center;">
                            <em>üîÑ Aggiornamento automatico ogni 5 secondi</em>
                        </div>
                    </div>
                `;
                
                // Scroll automatico verso l'alto per vedere i messaggi pi√π recenti
                const scrollContainer = resultDiv.querySelector('[style*="max-height: 500px"]');
                if (scrollContainer) {
                    scrollContainer.scrollTop = 0;
                }
                
            } catch (error) {
                console.error('Errore nella ricerca della conversazione:', error);
                document.getElementById('conversationResult').innerHTML = '<p>Errore nella ricerca della conversazione</p>';
            }
        }

        // Gestione selezione utenti
        function toggleSelectAll(checkbox) {
            const userCheckboxes = document.querySelectorAll('.user-checkbox');
            userCheckboxes.forEach(cb => {
                cb.checked = checkbox.checked;
            });
            updateBulkActions();
        }

        function updateBulkActions() {
            const selectedCheckboxes = document.querySelectorAll('.user-checkbox:checked');
            const count = selectedCheckboxes.length;
            
            const bulkActions = document.getElementById('bulkActions');
            const selectedCount = document.getElementById('selectedCount');
            
            if (count > 0) {
                bulkActions.classList.add('show');
                selectedCount.textContent = `${count} utenti selezionati`;
            } else {
                bulkActions.classList.remove('show');
            }
            
            // Aggiorna checkbox "seleziona tutto"
            const selectAllCheckbox = document.querySelector('.select-all-checkbox');
            const allCheckboxes = document.querySelectorAll('.user-checkbox');
            selectAllCheckbox.checked = allCheckboxes.length > 0 && selectedCheckboxes.length === allCheckboxes.length;
            selectAllCheckbox.indeterminate = selectedCheckboxes.length > 0 && selectedCheckboxes.length < allCheckboxes.length;
        }

        function clearSelection() {
            const checkboxes = document.querySelectorAll('.user-checkbox, .select-all-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = false;
                cb.indeterminate = false;
            });
            updateBulkActions();
        }

        async function deleteSelectedUsers() {
            const selectedCheckboxes = document.querySelectorAll('.user-checkbox:checked');
            const userIds = Array.from(selectedCheckboxes).map(cb => cb.value);
            
            if (userIds.length === 0) {
                alert('Nessun utente selezionato');
                return;
            }
            
            // Ottieni i nomi degli utenti per la conferma
            const selectedUsers = usersData.filter(user => userIds.includes(user.id.toString()));
            const userNames = selectedUsers.map(user => `${user.username} (${user.first_name} ${user.last_name})`).join(', ');
            
            if (!confirm(`Sei sicuro di voler eliminare ${userIds.length} utenti?\n\nUtenti selezionati:\n${userNames}\n\n‚ö†Ô∏è ATTENZIONE: Questa azione √® irreversibile e eliminer√† anche tutti i dati associati (messaggi, dispositivi, sessioni).`)) {
                return;
            }
            
            try {
                const response = await fetch('/admin/api/users/delete/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken(),
                    },
                    body: JSON.stringify({ user_ids: userIds })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(`‚úÖ ${result.deleted_count} utenti eliminati con successo`);
                    clearSelection();
                    loadUsers(); // Ricarica la tabella
                    loadStatistics(); // Aggiorna le statistiche
                } else {
                    alert(`‚ùå Errore durante l'eliminazione: ${result.error || 'Errore sconosciuto'}`);
                }
            } catch (error) {
                console.error('Errore durante l\'eliminazione:', error);
                alert('‚ùå Errore di connessione durante l\'eliminazione degli utenti');
            }
        }

        function getCsrfToken() {
            // Prova prima con il token nascosto
            let csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
            if (csrfToken) return csrfToken.value;
            
            // Fallback: prova con i meta tag
            csrfToken = document.querySelector('meta[name=csrf-token]');
            if (csrfToken) return csrfToken.getAttribute('content');
            
            // Fallback: prova con i cookie
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'csrftoken') {
                    return value;
                }
            }
            
            return '';
        }

        // Gestione Gruppi
        async function loadGroups() {
            try {
                const response = await fetch('/admin/api/groups/');
                const data = await response.json();
                
                const groupsTable = document.getElementById('groupsTable');
                groupsTable.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>Nome Gruppo</th>
                                <th>Descrizione</th>
                                <th>Colore</th>
                                <th>Membri</th>
                                <th>Creato da</th>
                                <th>Creato il</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.groups.map(group => `
                                <tr>
                                    <td><strong>${group.name}</strong></td>
                                    <td>${group.description || 'Nessuna descrizione'}</td>
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <div style="width: 20px; height: 20px; background: ${group.color}; border-radius: 4px;"></div>
                                            <span>${group.color}</span>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge badge-info">${group.members_count} membri</span>
                                        <button class="btn" style="margin-left: 10px; padding: 4px 8px; font-size: 0.8em;" onclick="manageGroupMembers('${group.id}', '${group.name}')">
                                            üë• Gestisci
                                        </button>
                                    </td>
                                    <td>${group.created_by_username}</td>
                                    <td>${new Date(group.created_at).toLocaleDateString()}</td>
                                    <td>
                                        <button class="btn" style="padding: 4px 8px; font-size: 0.8em; margin-right: 5px;" onclick="editGroup('${group.id}')">‚úèÔ∏è Modifica</button>
                                        <button class="btn btn-danger" style="padding: 4px 8px; font-size: 0.8em;" onclick="deleteGroup('${group.id}', '${group.name}')">üóëÔ∏è Elimina</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Errore nel caricamento dei gruppi:', error);
                document.getElementById('groupsTable').innerHTML = '<p>Errore nel caricamento dei gruppi</p>';
            }
        }

        function showCreateGroupModal() {
            document.getElementById('groupModalTitle').textContent = 'Crea Nuovo Gruppo';
            document.getElementById('groupForm').reset();
            document.getElementById('groupModal').style.display = 'block';
        }

        function closeGroupModal() {
            document.getElementById('groupModal').style.display = 'none';
        }

        async function editGroup(groupId) {
            // TODO: Implementare modifica gruppo
            alert('Funzionalit√† di modifica gruppo in sviluppo');
        }

        async function deleteGroup(groupId, groupName) {
            if (!confirm(`Sei sicuro di voler eliminare il gruppo "${groupName}"?\n\n‚ö†Ô∏è Gli utenti non verranno eliminati, ma perderanno l'appartenenza al gruppo.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/admin/api/groups/${groupId}/delete/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': getCsrfToken(),
                    }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(`‚úÖ Gruppo "${groupName}" eliminato con successo`);
                    loadGroups();
                } else {
                    alert(`‚ùå Errore: ${result.error || 'Errore sconosciuto'}`);
                }
            } catch (error) {
                console.error('Errore durante l\'eliminazione del gruppo:', error);
                alert('‚ùå Errore di connessione');
            }
        }

        async function manageGroupMembers(groupId, groupName) {
            // TODO: Implementare gestione membri gruppo
            alert(`Gestione membri per il gruppo "${groupName}" in sviluppo`);
        }

        // Gestione form gruppo
        document.addEventListener('DOMContentLoaded', function() {
            const groupForm = document.getElementById('groupForm');
            if (groupForm) {
                groupForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const formData = {
                        name: document.getElementById('groupName').value,
                        description: document.getElementById('groupDescription').value,
                        color: document.getElementById('groupColor').value,
                    };
                    
                    try {
                        const response = await fetch('/admin/api/groups/create/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCsrfToken(),
                            },
                            body: JSON.stringify(formData)
                        });
                        
                        const result = await response.json();
                        
                        if (response.ok) {
                            alert(`‚úÖ Gruppo "${formData.name}" creato con successo`);
                            closeGroupModal();
                            loadGroups();
                        } else {
                            alert(`‚ùå Errore: ${result.error || 'Errore sconosciuto'}`);
                        }
                    } catch (error) {
                        console.error('Errore durante la creazione del gruppo:', error);
                        alert('‚ùå Errore di connessione');
                    }
                });
            }
        });

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            loadStatistics();
            loadUsers();
        });
    </script>
</body>
</html>
